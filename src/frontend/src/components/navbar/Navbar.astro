---
import { menuConfig } from '@config/menu'
import ThemeSelector from './ThemeSelector.svelte'
import MaterialIcon from '../ui/MaterialIcon.astro'
import Logo from '../ui/icons/Logo.astro'

const mainMenuItems = menuConfig.main
---

<ai-navbar>
  <nav>
    <div class='nav-container'>
      <!-- Logo/Brand -->
      <div class='logo'>
        <a href='/' class='logo-link'>
          <Logo class='logo-icon' />
          <span>Meduza (ai_tools)</span>
        </a>
      </div>

      <!-- Desktop navigation -->
      <ul class='desktop-nav'>
        {
          mainMenuItems.map((item) => (
            <li>
              <a href={item.href} class='nav-link' id={item.id || undefined}>
                {item.icon && (
                  <MaterialIcon name={item.icon} width='20' height='20' />
                )}
                <span>{item.label}</span>
              </a>
            </li>
          ))
        }
        <li class='theme-selector-item'>
          <ThemeSelector client:load />
        </li>
      </ul>

      <!-- Mobile hamburger button -->
      <button id='hamburger' class='hamburger' aria-label='Toggle menu'>
        <span></span>
        <span></span>
        <span></span>
      </button>

      <!-- Mobile menu -->
      <div id='mobile-menu' class='mobile-menu'>
        <ul>
          {
            mainMenuItems.map((item) => (
              <li>
                <a href={item.href} class='nav-link' id={item.id || undefined}>
                  {item.icon && (
                    <MaterialIcon name={item.icon} width='20' height='20' />
                  )}
                  <span>{item.label}</span>
                </a>
              </li>
            ))
          }
          <li class='theme-selector-item mobile-theme-selector'>
            <ThemeSelector client:load />
          </li>
        </ul>
      </div>
    </div>
  </nav>
</ai-navbar>

<script>
  class AiNavbar extends HTMLElement {
    constructor() {
      super()
    }

    connectedCallback() {
      this.initActiveLinks()
      this.initMobileMenu()
      this.initScrollHide()
    }

    initActiveLinks() {
      const currentPath = window.location.pathname
      const navLinks = this.querySelectorAll('.nav-link')

      navLinks.forEach((link) => {
        const href = link.getAttribute('href')
        if (href === currentPath || (currentPath === '/' && href === '/')) {
          link.classList.add('active')
        } else {
          link.classList.remove('active')
        }
      })
    }

    initMobileMenu() {
      const hamburger = this.querySelector('#hamburger')
      const mobileMenu = this.querySelector('#mobile-menu')
      const body = document.body
      const menuLinks = mobileMenu?.querySelectorAll('a')

      if (hamburger && mobileMenu) {
        // Toggle menu
        hamburger.addEventListener('click', () => {
          const isOpen = mobileMenu.classList.toggle('open')
          hamburger.classList.toggle('open')
          if (isOpen) {
            body.style.overflow = 'hidden'
          } else {
            body.style.overflow = 'auto'
          }
        })

        // Close when clicking links
        menuLinks?.forEach((link) => {
          link.addEventListener('click', () => {
            mobileMenu.classList.remove('open')
            hamburger.classList.remove('open')
            body.style.overflow = 'auto'
          })
        })
      }
    }

    initScrollHide() {
      const nav = this.querySelector('nav')
      if (!nav) return

      const scrollThreshold = 10
      let lastScrollY = window.scrollY

      const handleScroll = () => {
        const currentScrollY = window.scrollY

        // Filter out small jitter (accumulate delta)
        if (Math.abs(currentScrollY - lastScrollY) < scrollThreshold) return

        // Direction check
        const isScrollingDown = currentScrollY > lastScrollY
        const isScrollingUp = !isScrollingDown

        // Boundary checks
        // Keep visible at very top
        const isAtTop = currentScrollY < 60
        // Keep visible at very bottom (prevent bouncing/unreachable footer)
        const isAtBottom =
          window.innerHeight + currentScrollY >= document.body.offsetHeight - 20

        if (isScrollingDown && !isAtTop && !isAtBottom) {
          nav.classList.add('nav-hidden')
        } else if (isScrollingUp) {
          nav.classList.remove('nav-hidden')
        }

        lastScrollY = currentScrollY
      }

      // Add capture listener to window to catch ALL scrolls
      window.addEventListener('scroll', handleScroll, {
        capture: true,
        passive: true
      })
    }
  }

  // Define the custom element
  customElements.define('ai-navbar', AiNavbar)
</script>

<style>
  nav {
    width: 100%;
    background-color: var(--md-surface, #fff);
    border-bottom: 1px solid var(--border-color, #e0e0e0);
    position: sticky;
    top: 0;
    z-index: 100;
    transition:
      background-color 0.3s ease,
      border-color 0.3s ease,
      transform 0.3s ease;
    overflow: hidden;
  }

  nav.nav-hidden {
    transform: translateY(-100%);
  }

  .nav-container {
    margin: 0 auto;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .logo {
    font-size: 1.5rem;
    font-weight: 700;
  }

  .logo-link {
    text-decoration: none;
    color: var(--text-primary, #100f0f);
    transition: color 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .logo-link:hover {
    color: var(--accent-color, #b12424);
  }

  .logo-icon {
    width: 48px;
    height: 48px;
    flex-shrink: 0;
  }

  .desktop-nav {
    display: none;
    list-style: none;
    margin: 0;
    padding: 0;
    gap: 2rem;
    align-items: center;
  }

  .desktop-nav li {
    margin: 0;
  }

  .theme-selector-item {
    display: flex;
    align-items: center;
  }

  .mobile-theme-selector {
    padding: 1rem 2rem;
    border-bottom: 1px solid var(--border-color, #e0e0e0);
  }

  .nav-link {
    text-decoration: none;
    color: var(--text-secondary, #666);
    font-size: 1rem;
    font-weight: 500;
    padding: 0.5rem 0;
    transition: color 0.2s;
    position: relative;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .nav-link:hover {
    color: var(--accent-color, #b12424);
  }

  .nav-link.active {
    color: var(--accent-color, #b12424);
  }

  .nav-link.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background-color: var(--accent-color, #b12424);
  }

  /* Hamburger menu button - mobile only */
  .hamburger {
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    width: 2rem;
    height: 2rem;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0;
    z-index: 1001;
  }

  .hamburger span {
    width: 2rem;
    height: 0.25rem;
    background: var(--text-primary, #333);
    border-radius: 8px;
    transition: all 0.3s linear;
    position: relative;
    transform-origin: 1px;
  }

  .hamburger.open span:nth-child(1) {
    transform: rotate(45deg);
  }

  .hamburger.open span:nth-child(2) {
    opacity: 0;
    transform: translateX(20px);
  }

  .hamburger.open span:nth-child(3) {
    transform: rotate(-45deg);
  }

  /* Mobile menu */
  .mobile-menu {
    position: fixed;
    top: 0;
    right: -100%;
    width: 80%;
    max-width: 300px;
    height: 100vh;
    background: var(--bg-primary, #fff);
    box-shadow: -2px 0 10px var(--shadow, rgba(0, 0, 0, 0.1));
    transition:
      right 0.3s ease-in-out,
      background-color 0.3s ease;
    z-index: 1000;
    overflow-y: auto;
    padding-top: 4rem;
  }

  .mobile-menu.open {
    right: 0;
  }

  .mobile-menu ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
  }

  .mobile-menu li {
    width: 100%;
    border-bottom: 1px solid var(--border-color, #e0e0e0);
  }

  .mobile-menu .nav-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 2rem;
    color: var(--text-primary, #333);
    font-size: 1.1rem;
  }

  .mobile-menu .nav-link:hover {
    background-color: var(--bg-secondary, #f5f5f5);
  }

  .mobile-menu .nav-link.active {
    background-color: var(--bg-secondary, #f5f5f5);
  }

  .mobile-menu .nav-link.active::after {
    display: none;
  }

  /* Tablet and desktop styles */
  @media screen and (min-width: 768px) {
    .nav-container {
      padding: 1rem 2rem;
    }

    .desktop-nav {
      display: flex;
    }

    .hamburger {
      display: none;
    }

    .mobile-menu {
      display: none;
    }
  }
</style>
